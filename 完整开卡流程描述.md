# 完整开卡流程描述

## 一、卡片页面入口逻辑（CardScreen）

### 1. 页面初始化
**时机**：用户进入卡片页面（CardScreen）
**调用接口**：`GET /api/v1/card/list`
**目的**：检查用户是否已有卡片

**逻辑判断**：
- **如果接口返回有卡片（total > 0）**：
  - 展示**卡片详情页面**（图片中的UI）
  - 显示卡片信息、余额、操作按钮、交易记录等
  
- **如果接口返回无卡片（total = 0 或接口报错）**：
  - 展示**申请卡片页面**
  - 显示"立即申请"按钮和卡片介绍

---

## 二、申请卡片流程

### 2.1 判断是否需要KYC
**时机**：用户点击"立即申请"或"申请新卡"按钮
**调用接口**：`GET /api/v1/kyc/eligibility`
**逻辑判断**：
- **如果用户已有KYC记录（eligible = true 或已有KYC数据）**：
  - **跳过KYC流程**，直接进入支付页面
  - 支付完成后，直接调用申请接口和查询进度
  
- **如果用户没有KYC记录（eligible = false）**：
  - **需要完整KYC流程**，进入支付页面 → KYC填写 → Didit认证 → OTP验证

### 2.2 点击"立即申请"或"申请新卡"按钮
**时机**：用户在申请页面点击"立即申请"，或在卡片详情页点击"申请新卡"
**跳转**：进入 `CardApplyConfirmScreen`（开卡费支付确认页）

### 2.2 开卡费支付页面（CardApplyConfirmScreen）
**时机**：进入支付确认页面
**调用接口**：
1. `GET /api/v1/CardFee/GetConfig?card_type=virtual` - 获取开卡费配置
2. `GET /api/v1/CardFee/GetCurrencies` - 获取支持的支付币种列表
3. `GET /api/v1/wallet/` - 获取用户钱包余额（用于显示各币种余额）

**UI展示**：
- 卡片信息（卡名称、卡组织、开卡费）
- 优惠券选择（可选）
- 支付币种选择（显示余额，余额不足的币种不可选）
- 提交按钮

**用户操作**：
1. （可选）选择优惠券
2. 选择支付币种
3. 点击"提交"按钮

### 2.3 创建支付订单
**时机**：用户点击"提交"按钮
**调用接口**：`POST /api/v1/CardFee/CreatePayment`
**请求参数**：
```json
{
  "card_type": "virtual",
  "coupon_code": "xxx" // 可选
}
```
**返回数据**：`transaction_ref`（交易参考号）

**UI展示**：显示支付确认对话框，显示实际支付金额

### 2.4 完成支付
**时机**：用户在确认对话框点击"确认"
**调用接口**：`POST /api/v1/CardFee/CompletePayment/{transaction_ref}`
**请求参数**：
```json
{
  "payment_currency": "USDT-TRC20" // 用户选择的支付币种
}
```

**支付状态轮询**：
- 调用 `GET /api/v1/CardFee/GetPaymentStatus` 轮询支付状态
- 每2秒查询一次，最多查询10次
- 直到状态变为 `completed` 或 `failed`

**支付成功后**：
- 检查KYC资格：`GET /api/v1/kyc/eligibility`
- **如果 `eligible = true`（已有KYC）**：
  - **跳过KYC流程**，直接调用 `POST /api/v1/card/apply` 申请卡片
  - 获取 `task_id` 后，跳转到开卡进度页面
- **如果 `eligible = false`（无KYC）**：
  - 跳转到KYC填写资料页面（继续完整流程）

### 2.5 KYC填写资料页面（CardVerificationScreen）
**时机**：支付成功后跳转
**UI展示**：个人信息填写表单
- Name（英文大写）
- Surname（英文大写）
- Mobile Phone
- Country/Region
- State/Province
- City
- Detailed Address
- Post Code

**用户操作**：填写信息后点击"Continue"

### 2.6 初始化Didit KYC
**时机**：用户点击"Continue"按钮
**调用接口**：`POST /api/v1/user/initialize-didit-token`
**请求参数**：包含用户填写的所有个人信息
**返回数据**：Didit认证URL

**跳转**：进入 `ProfilkycDiditScreen`（WebView页面）

### 2.7 Didit KYC认证（ProfilkycDiditScreen）
**时机**：进入WebView页面
**UI展示**：加载Didit认证页面（WebView）
**用户操作**：在WebView中完成身份认证（拍照、上传证件等）

**认证完成后**：跳转到 `CardOtpScreen`（OTP验证页）

### 2.8 OTP验证页面（CardOtpScreen）
**时机**：Didit认证完成后跳转
**UI展示**：OTP输入框（6位验证码）

**用户操作**：输入验证码，点击"Verify"

**验证成功后**：
1. **调用卡片申请接口**：`POST /api/v1/card/apply`
   - 请求参数：`{"physical": false}`（申请虚拟卡）
   - 返回数据：`task_id`（任务ID）
   
2. **保存task_id**，跳转到开卡进度页面

### 2.9 开卡进度页面（CardApplyProgressScreen）【新增页面】
**时机**：OTP验证成功并调用申请接口后跳转
**调用接口**：`GET /api/v1/card/apply/progress/{task_id}`
**轮询频率**：每3秒查询一次，直到状态变为 `completed` 或 `failed`

**UI展示**：
- 进度状态指示器（pending/processing/completed/failed）
- 进度条或状态文字
- 如果状态为 `completed`，显示已创建的卡片列表（从返回的 `list` 字段获取）

**状态处理**：
- **pending/processing**：显示"处理中"，继续轮询
- **completed**：显示"开卡成功"，3秒后跳转到完成页
- **failed**：显示"开卡失败"，允许重试

**跳转**：开卡成功后跳转到 `CardCompliteScreen`

### 2.10 申请完成页面（CardCompliteScreen）
**时机**：开卡进度完成后跳转
**UI展示**："Application Complete"成功提示
**自动跳转**：3秒后跳转到 `CardCompliteStatusScreen`

### 2.11 状态页面（CardCompliteStatusScreen）
**时机**：从完成页自动跳转
**UI展示**："Application Successful"成功提示
**自动跳转**：3秒后返回 `CardScreen`（卡片首页）

---

## 三、卡片详情页面（有卡用户）

### 3.1 页面加载
**时机**：用户进入CardScreen，检测到有卡片（total > 0）
**调用接口**：
1. `GET /api/v1/card/list` - 获取卡片列表（已调用）
2. `GET /api/v1/card/account-details?public_token={public_token}` - 获取当前选中卡片的详细信息
3. `GET /api/v1/card/transaction-history?public_token={public_token}&page=1&limit=20` - 获取当前卡片的交易记录

**重要**：
- 默认选中第一张卡片（index 0）
- 如果有多张卡片，支持左右滑动切换
- 切换卡片时，重新调用接口2和3，更新页面所有数据

### 3.2 多卡片支持
**卡片数量**：最多5张卡片
**卡片切换**：
- 使用PageView或类似的滑动组件实现左右滑动
- 滑动切换时，触发以下操作：
  1. 更新当前选中的卡片索引
  2. 调用 `GET /api/v1/card/account-details?public_token={新卡片的public_token}`
  3. 调用 `GET /api/v1/card/transaction-history?public_token={新卡片的public_token}&page=1&limit=20`
  4. 更新页面所有显示数据（余额、卡号、交易记录等）

**继续开卡入口**：
- 在卡片详情页面顶部或底部添加"申请新卡"按钮
- 点击后进入支付流程（如果是第二次及以后开卡，跳过KYC）

### 3.3 UI展示（参考图片）
**顶部区域**：
- 可用额度估值（Estimated Available Credit）ⓘ - 显示当前选中卡片的余额
- 费率信息（Rate）ⓘ - 显示当前选中卡片的费率
- （可选）卡片数量指示器（如：1/3，表示第1张，共3张）

**卡片展示区域**（可滑动）：
- 虚拟卡片图形（绿色渐变背景）
- 卡片左上角：P logo
- 卡片右上角：费率信息
- 卡片号码：`441353******5037`（带眼睛图标，可切换显示/隐藏）
- 持卡人姓名：`HONG ZHAO`
- CVV：`***`（可点击查看）
- 到期日：`***`（可点击查看）
- 卡片右下角：VISA Platinum logo
- **支持左右滑动切换卡片**

**操作按钮区域**（5个圆形按钮）：
1. **卡信息**（Card Information）- 点击查看卡片详细信息
2. **鎖卡**（Lock Card）- 点击锁定/解锁卡片
3. **卡片授權**（Card Authorization）- 点击进入授权管理
4. **申領實體卡**（Apply for Physical Card）- 点击申请实体卡
5. **掛失**（Report Loss）- 点击挂失卡片

**交易记录区域**：
- 标题："賬單"（Bill/Statement）
- 右上角：查看更多/筛选图标
- 交易列表：显示**当前选中卡片**的交易记录（商户、时间、金额、状态）
- 切换卡片时，交易记录自动更新为当前卡片的数据

### 3.3 卡片信息查看（点击"卡信息"按钮）
**时机**：用户点击"卡信息"按钮
**调用接口**：`GET /api/v1/card/account-details?public_token={public_token}`
**UI展示**：弹窗或新页面显示：
- 卡片基本信息（卡号、余额、状态、币种）
- 限额信息（单笔限额、日限额、月限额）
- 手续费信息（充值费率、提现费率、交易费率）
- 有效期、激活时间等

### 3.4 查看CVV（点击CVV区域）
**时机**：用户点击卡片上的CVV区域
**调用接口**：`GET /api/v1/card/cvv?public_token={public_token}`
**UI展示**：
- 显示CVV码（如：583）
- 3-5秒后自动隐藏
- 不存储到本地

### 3.5 查看PIN（如需要）
**时机**：用户需要查看PIN码时（可能在卡信息页面）
**调用接口**：`GET /api/v1/card/pin?public_token={public_token}`
**UI展示**：
- 显示PIN码（如：4059）
- 3-5秒后自动隐藏
- 不存储到本地

### 3.6 查看完整卡号（如需要）
**时机**：用户需要查看完整卡号时（可能在卡信息页面）
**调用接口**：`POST /api/v1/card/full-number`
**请求参数**：
```json
{
  "public_token": "123791920"
}
```
**UI展示**：
- 显示完整卡号和CVV
- 3-5秒后自动隐藏
- 不存储到本地

### 3.7 交易记录加载更多
**时机**：用户滚动到交易记录列表底部
**调用接口**：`GET /api/v1/card/transaction-history?public_token={public_token}&page={page}&limit=20`
**分页逻辑**：
- 初始加载：page=1, limit=20
- 加载更多：page递增，每次加载20条
- 直到返回的 `total` 等于已加载数量

---

## 四、页面刷新逻辑

### 4.1 从其他页面返回CardScreen
**时机**：从开卡流程完成页返回，或从其他页面切换回卡片页
**调用接口**：`GET /api/v1/card/list`
**逻辑**：
- 重新检查是否有卡片
- 如果有卡片，刷新卡片详情和交易记录
- 如果无卡片，显示申请页面

### 4.2 下拉刷新
**时机**：用户在卡片详情页面下拉刷新
**调用接口**：
1. `GET /api/v1/card/list` - 刷新卡片列表
2. `GET /api/v1/card/account-details?public_token={public_token}` - 刷新卡片详情
3. `GET /api/v1/card/transaction-history?public_token={public_token}&page=1&limit=20` - 刷新交易记录（重置分页）

---

## 五、错误处理

### 5.1 接口调用失败
- 显示友好的错误提示
- 提供重试按钮
- 网络错误时提示检查网络连接

### 5.2 支付失败
- 显示支付失败原因
- 允许重新选择币种和支付
- 保留已创建的支付订单（如有）

### 5.3 开卡失败
- 显示开卡失败原因
- 允许重新申请
- 记录失败原因供用户查看

### 5.4 敏感信息获取失败
- 显示错误提示
- 允许重试
- 不显示敏感信息

---

## 六、关键接口汇总

| 功能 | 接口 | 方法 | 调用时机 |
|------|------|------|----------|
| 检查是否有卡 | `/api/v1/card/list` | GET | CardScreen初始化 |
| 获取开卡费配置 | `/api/v1/CardFee/GetConfig` | GET | 进入支付页面 |
| 获取支付币种 | `/api/v1/CardFee/GetCurrencies` | GET | 进入支付页面 |
| 创建支付订单 | `/api/v1/CardFee/CreatePayment` | POST | 点击提交按钮 |
| 完成支付 | `/api/v1/CardFee/CompletePayment/{ref}` | POST | 确认支付 |
| 查询支付状态 | `/api/v1/CardFee/GetPaymentStatus` | GET | 支付后轮询 |
| 检查KYC资格 | `/api/v1/kyc/eligibility` | GET | 支付成功后 |
| 初始化Didit | `/api/v1/user/initialize-didit-token` | POST | KYC填写完成 |
| 申请卡片 | `/api/v1/card/apply` | POST | OTP验证成功后 |
| 查询开卡进度 | `/api/v1/card/apply/progress/{task_id}` | GET | 申请后轮询 |
| 获取卡片详情 | `/api/v1/card/account-details` | GET | 有卡时加载详情 |
| 获取交易记录 | `/api/v1/card/transaction-history` | GET | 有卡时加载交易 |
| 获取CVV | `/api/v1/card/cvv` | GET | 点击查看CVV |
| 获取PIN | `/api/v1/card/pin` | GET | 点击查看PIN |
| 获取完整卡号 | `/api/v1/card/full-number` | POST | 点击查看完整卡号 |
| 卡片充值 | `/api/v1/card/recharge` | POST | 暂不实现 |
| 卡片提现 | `/api/v1/card/withdraw` | POST | 暂不实现 |

---

## 七、状态流转图

```
[CardScreen初始化]
    ↓
[调用 /api/v1/card/list]
    ↓
    ├─→ [有卡] → [展示卡片详情页（支持滑动切换）]
    │       ↓
    │   [调用 /api/v1/card/account-details] → [展示当前卡片详情]
    │       ↓
    │   [调用 /api/v1/card/transaction-history] → [展示当前卡片交易记录]
    │       ↓
    │   [用户滑动切换卡片] → [重新调用接口，更新所有数据]
    │       ↓
    │   [点击"申请新卡"] → [检查KYC资格]
    │
    └─→ [无卡] → [展示申请页面]
            ↓
        [点击"立即申请"]
            ↓
        [检查KYC资格]
            ↓
            ├─→ [已有KYC] → [CardApplyConfirmScreen - 支付开卡费]
            │       ↓
            │   [支付成功] → [调用 /api/v1/card/apply] → [获取task_id]
            │       ↓
            │   [CardApplyProgressScreen - 开卡进度]
            │       ↓
            │   [轮询 /api/v1/card/apply/progress/{task_id}]
            │       ↓
            │   [开卡完成] → [返回CardScreen] → [重新检查卡片列表]
            │
            └─→ [无KYC] → [CardApplyConfirmScreen - 支付开卡费]
                    ↓
                [支付成功] → [CardVerificationScreen - KYC填资料]
                    ↓
                [ProfilkycDiditScreen - Didit认证]
                    ↓
                [CardOtpScreen - OTP验证]
                    ↓
                [调用 /api/v1/card/apply] → [获取task_id]
                    ↓
                [CardApplyProgressScreen - 开卡进度]
                    ↓
                [轮询 /api/v1/card/apply/progress/{task_id}]
                    ↓
                [开卡完成] → [返回CardScreen] → [重新检查卡片列表]
```

---

_文档生成时间：2025-12-25_

