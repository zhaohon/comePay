# å®æˆ˜æ¼”ç»ƒï¼šæ·»åŠ å¼€å¡è´¹æ”¯ä»˜åŠŸèƒ½

> **ç›®æ ‡**ï¼šé€šè¿‡å®é™…ä»£ç ç¤ºä¾‹ï¼Œå­¦ä¼šåœ¨ Provider é¡¹ç›®ä¸­æ·»åŠ æ–°åŠŸèƒ½  
> **æ–¹æ³•**ï¼šå·¦è¾¹ GetX å†™æ³•ï¼Œå³è¾¹ Provider å†™æ³•ï¼Œå¯¹æ¯”å­¦ä¹ 

---

## ğŸ¯ ä»»åŠ¡ç›®æ ‡

ä¸ºé¡¹ç›®æ·»åŠ "å¼€å¡è´¹æ”¯ä»˜"åŠŸèƒ½ï¼Œéœ€è¦ï¼š

1. åˆ›å»º CardFeeServiceï¼ˆè°ƒç”¨ APIï¼‰
2. åˆ›å»º CardFeeViewModelï¼ˆç®¡ç†çŠ¶æ€ï¼‰
3. ä¿®æ”¹ CardApplyConfirmScreenï¼ˆUI ç•Œé¢ï¼‰

---

## ğŸ“ æ­¥éª¤ 1ï¼šåˆ›å»ºæ•°æ®æ¨¡å‹

### æ”¯ä»˜è®¢å•æ¨¡å‹ï¼ˆGetX å’Œ Provider é€šç”¨ï¼‰

```dart
// lib/models/card_fee_payment_model.dart

class CardFeePaymentModel {
  final int id;
  final int userId;
  final String cardType;
  final double originalFee;
  final double couponDiscount;
  final double actualPayment;
  final String status;  // pending, completed
  final String transactionRef;
  final String? paymentMethod;
  final String? couponCode;
  final DateTime createdAt;

  CardFeePaymentModel({
    required this.id,
    required this.userId,
    required this.cardType,
    required this.originalFee,
    required this.couponDiscount,
    required this.actualPayment,
    required this.status,
    required this.transactionRef,
    this.paymentMethod,
    this.couponCode,
    required this.createdAt,
  });

  factory CardFeePaymentModel.fromJson(Map<String, dynamic> json) {
    return CardFeePaymentModel(
      id: json['id'] ?? 0,
      userId: json['user_id'] ?? 0,
      cardType: json['card_type'] ?? '',
      originalFee: (json['original_fee'] ?? 0).toDouble(),
      couponDiscount: (json['coupon_discount'] ?? 0).toDouble(),
      actualPayment: (json['actual_payment'] ?? 0).toDouble(),
      status: json['status'] ?? '',
      transactionRef: json['transaction_ref'] ?? '',
      paymentMethod: json['payment_method'],
      couponCode: json['coupon_code'],
      createdAt: DateTime.parse(json['created_at'] ?? DateTime.now().toIso8601String()),
    );
  }
}
```

**ğŸ’¡ è¿™éƒ¨åˆ† GetX å’Œ Provider å®Œå…¨ä¸€æ ·ï¼**

---

## ğŸ“ æ­¥éª¤ 2ï¼šåˆ›å»º Serviceï¼ˆAPI è°ƒç”¨å±‚ï¼‰

### GetX é£æ ¼ vs Provider é£æ ¼

<table>
<tr>
<th>GetXå†™æ³•ï¼ˆä½ ç†Ÿæ‚‰çš„ï¼‰</th>
<th>Providerå†™æ³•ï¼ˆé¡¹ç›®è¦æ±‚ï¼‰</th>
</tr>
<tr>
<td>

```dart
// GetXé€šå¸¸ç›´æ¥åœ¨Controlleré‡Œè°ƒç”¨
class CardFeeController extends GetxController {
  final _dio = Dio();

  Future<Payment> createPayment(
    String cardType,
    String? couponCode,
  ) async {
    final response = await _dio.post(
      '/api/v1/CardFee/CreatePayment',
      data: {
        'card_type': cardType,
        'coupon_code': couponCode,
      },
    );
    return Payment.fromJson(response.data);
  }
}
```

</td>
<td>

```dart
// lib/services/card_fee_service.dart

import 'package:dio/dio.dart';
import 'package:comecomepay/core/base_service.dart';
import 'package:comecomepay/models/card_fee_payment_model.dart';
import 'package:comecomepay/services/hive_storage_service.dart';

class CardFeeService extends BaseService {
  // 1. è®¾ç½®åŸºç¡€URL
  @override
  String get baseUrl => 'http://149.88.65.193:8010';

  // 2. åˆ›å»ºæ”¯ä»˜è®¢å•
  Future<CardFeePaymentModel> createPayment({
    required String cardType,
    String? couponCode,
  }) async {
    final token = HiveStorageService.getAccessToken();

    final response = await dio.post(
      '/api/v1/CardFee/CreatePayment',
      data: {
        'card_type': cardType,
        if (couponCode != null) 'coupon_code': couponCode,
      },
      options: Options(
        headers: {'Authorization': 'Bearer $token'},
      ),
    );

    if (response.statusCode == 200) {
      final payment = response.data['payment'];
      return CardFeePaymentModel.fromJson(payment);
    } else {
      throw Exception('åˆ›å»ºæ”¯ä»˜å¤±è´¥');
    }
  }

  // 3. å®Œæˆæ”¯ä»˜
  Future<CardFeePaymentModel> completePayment({
    required String transactionRef,
    required String paymentCurrency,
  }) async {
    final token = HiveStorageService.getAccessToken();

    final response = await dio.post(
      '/api/v1/CardFee/CompletePayment/$transactionRef',
      data: {'payment_currency': paymentCurrency},
      options: Options(
        headers: {'Authorization': 'Bearer $token'},
      ),
    );

    if (response.statusCode == 200) {
      return CardFeePaymentModel.fromJson(
        response.data['payment']
      );
    } else {
      throw Exception('æ”¯ä»˜å¤±è´¥');
    }
  }
}
```

</td>
</tr>
</table>

**å…³é”®åŒºåˆ«**ï¼š

- GetXï¼šç›´æ¥åœ¨ Controller é‡Œè°ƒ API
- Providerï¼šå•ç‹¬çš„ Service å±‚ï¼Œç»§æ‰¿`BaseService`

---

## ğŸ“ æ­¥éª¤ 3ï¼šåˆ›å»º ViewModelï¼ˆçŠ¶æ€ç®¡ç†å±‚ï¼‰

è¿™æ˜¯**æœ€æ ¸å¿ƒçš„éƒ¨åˆ†**ï¼

<table>
<tr>
<th>âŒ GetXå†™æ³•ï¼ˆä½ ç†Ÿæ‚‰çš„ï¼‰</th>
<th>âœ… Providerå†™æ³•ï¼ˆé¡¹ç›®è¦æ±‚ï¼‰</th>
</tr>
<tr>
<td>

```dart
// GetX Controller
class CardFeeController extends GetxController {
  final _service = CardFeeService();

  // å“åº”å¼å˜é‡
  var isLoading = false.obs;
  var errorMessage = ''.obs;
  var payment = Rx<Payment?>(null);
  var selectedCoupon = Rx<Coupon?>(null);

  // åˆ›å»ºæ”¯ä»˜
  Future<void> createPayment() async {
    isLoading(true);  // è‡ªåŠ¨æ›´æ–°UI
    errorMessage('');

    try {
      final result = await _service.createPayment(
        cardType: 'virtual',
        couponCode: selectedCoupon.value?.code,
      );

      payment(result);  // è‡ªåŠ¨æ›´æ–°UI
    } catch (e) {
      errorMessage(e.toString());
    } finally {
      isLoading(false);  // è‡ªåŠ¨æ›´æ–°UI
    }
  }

  // é€‰æ‹©ä¼˜æƒ åˆ¸
  void selectCoupon(Coupon coupon) {
    selectedCoupon(coupon);  // è‡ªåŠ¨æ›´æ–°UI
  }
}
```

</td>
<td>

```dart
// lib/viewmodels/card_fee_viewmodel.dart

import 'package:flutter/material.dart';
import 'package:comecomepay/models/card_fee_payment_model.dart';
import 'package:comecomepay/models/responses/coupon_model.dart';
import 'package:comecomepay/services/card_fee_service.dart';

class CardFeeViewModel extends ChangeNotifier {
  final CardFeeService _service = CardFeeService();

  // ========== 1. ç§æœ‰çŠ¶æ€å˜é‡ ==========
  // âš ï¸ GetXç”¨.obsï¼ŒProviderç”¨ç§æœ‰å˜é‡
  bool _isLoading = false;
  String? _errorMessage;
  CardFeePaymentModel? _payment;
  CouponModel? _selectedCoupon;

  // ========== 2. Getterï¼ˆæš´éœ²ç»™UIï¼‰ ==========
  // âš ï¸ GetXç›´æ¥è®¿é—®ï¼ŒProvideré€šè¿‡getter
  bool get isLoading => _isLoading;
  String? get errorMessage => _errorMessage;
  CardFeePaymentModel? get payment => _payment;
  CouponModel? get selectedCoupon => _selectedCoupon;

  // è®¡ç®—å®é™…æ”¯ä»˜é‡‘é¢
  double get actualPayment {
    if (_payment != null) {
      return _payment!.actualPayment;
    }
    return 5.0; // é»˜è®¤å¼€å¡è´¹
  }

  // ========== 3. ä¸šåŠ¡æ–¹æ³• ==========

  // åˆ›å»ºæ”¯ä»˜è®¢å•
  Future<bool> createPayment(String cardType) async {
    _isLoading = true;
    _errorMessage = null;
    notifyListeners();  // âš ï¸ æ‰‹åŠ¨é€šçŸ¥UIæ›´æ–°

    try {
      final result = await _service.createPayment(
        cardType: cardType,
        couponCode: _selectedCoupon?.coupon.code,
      );

      _payment = result;
      _errorMessage = null;
      _isLoading = false;
      notifyListeners();  // âš ï¸ å†æ¬¡é€šçŸ¥UIæ›´æ–°
      return true;
    } catch (e) {
      _errorMessage = e.toString();
      _isLoading = false;
      notifyListeners();  // âš ï¸ å†æ¬¡é€šçŸ¥UIæ›´æ–°
      return false;
    }
  }

  // å®Œæˆæ”¯ä»˜
  Future<bool> completePayment(String currency) async {
    if (_payment == null) return false;

    _isLoading = true;
    notifyListeners();  // âš ï¸ é€šçŸ¥UI

    try {
      final result = await _service.completePayment(
        transactionRef: _payment!.transactionRef,
        paymentCurrency: currency,
      );

      _payment = result;
      _isLoading = false;
      notifyListeners();  // âš ï¸ é€šçŸ¥UI
      return true;
    } catch (e) {
      _errorMessage = e.toString();
      _isLoading = false;
      notifyListeners();  // âš ï¸ é€šçŸ¥UI
      return false;
    }
  }

  // é€‰æ‹©ä¼˜æƒ åˆ¸
  void selectCoupon(CouponModel? coupon) {
    _selectedCoupon = coupon;
    notifyListeners();  // âš ï¸ é€šçŸ¥UI
  }

  // æ¸…é™¤é”™è¯¯
  void clearError() {
    _errorMessage = null;
    notifyListeners();  // âš ï¸ é€šçŸ¥UI
  }
}
```

</td>
</tr>
</table>

**æ ¸å¿ƒåŒºåˆ«æ€»ç»“**ï¼š

| ç‰¹æ€§     | GetX                             | Provider (é¡¹ç›®)                         |
| -------- | -------------------------------- | --------------------------------------- |
| çŠ¶æ€å˜é‡ | `var name = ''.obs`              | `String _name = ''`                     |
| æš´éœ²çŠ¶æ€ | ç›´æ¥è®¿é—® `controller.name.value` | Getter `String get name => _name`       |
| æ›´æ–° UI  | è‡ªåŠ¨ `name.value = 'new'`        | æ‰‹åŠ¨ `_name = 'new'; notifyListeners()` |
| æ¯æ¬¡ä¿®æ”¹ | ä¸ç”¨ç®¡                           | **å¿…é¡»è°ƒç”¨** `notifyListeners()`        |

---

## ğŸ“ æ­¥éª¤ 4ï¼šä¿®æ”¹ UI é¡µé¢

### ä¿®æ”¹ CardApplyConfirmScreen

<table>
<tr>
<th>âŒ GetXå†™æ³•</th>
<th>âœ… Providerå†™æ³•ï¼ˆé¡¹ç›®è¦æ±‚ï¼‰</th>
</tr>
<tr>
<td>

```dart
class CardApplyConfirmScreen
    extends StatelessWidget {
  final controller = Get.put(CardFeeController());

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Column(
        children: [
          // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
          Obx(() => controller.isLoading.value
            ? CircularProgressIndicator()
            : SizedBox.shrink()
          ),

          // æ˜¾ç¤ºé€‰ä¸­çš„ä¼˜æƒ åˆ¸
          Obx(() => Text(
            controller.selectedCoupon.value?.name
              ?? 'æ— ä¼˜æƒ åˆ¸'
          )),

          // æäº¤æŒ‰é’®
          ElevatedButton(
            onPressed: () async {
              await controller.createPayment();
              if (controller.payment.value != null) {
                Get.to(() => NextPage());
              }
            },
            child: Text('æäº¤'),
          ),
        ],
      ),
    );
  }
}
```

</td>
<td>

```dart
// lib/views/homes/CardApplyConfirmScreen.dart

class CardApplyConfirmScreen extends StatefulWidget {
  @override
  State<CardApplyConfirmScreen>
      createState() => _CardApplyConfirmScreenState();
}

class _CardApplyConfirmScreenState
    extends State<CardApplyConfirmScreen> {
  // ========== 1. åˆ›å»ºViewModel ==========
  late CardFeeViewModel _cardFeeViewModel;

  @override
  void initState() {
    super.initState();
    // å®ä¾‹åŒ–ViewModel
    _cardFeeViewModel = CardFeeViewModel();

    // âš ï¸ ç›‘å¬ViewModelå˜åŒ–
    _cardFeeViewModel.addListener(_onViewModelChanged);
  }

  // ========== 2. ç›‘å¬å›è°ƒ ==========
  void _onViewModelChanged() {
    setState(() {});  // å¼ºåˆ¶UIé‡å»º
  }

  @override
  void dispose() {
    // âš ï¸ å¿…é¡»ç§»é™¤ç›‘å¬ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
    _cardFeeViewModel
        .removeListener(_onViewModelChanged);
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Column(
        children: [
          // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
          if (_cardFeeViewModel.isLoading)
            CircularProgressIndicator()
          else
            SizedBox.shrink(),

          // æ˜¾ç¤ºé€‰ä¸­çš„ä¼˜æƒ åˆ¸
          Text(_cardFeeViewModel.selectedCoupon
                  ?.coupon.name ?? 'æ— ä¼˜æƒ åˆ¸'),

          // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
          if (_cardFeeViewModel.errorMessage != null)
            Text(
              _cardFeeViewModel.errorMessage!,
              style: TextStyle(color: Colors.red),
            ),

          // æäº¤æŒ‰é’®
          ElevatedButton(
            onPressed: _cardFeeViewModel.isLoading
              ? null
              : () async {
                  final success = await _cardFeeViewModel
                      .createPayment('virtual');

                  if (success) {
                    Navigator.push(
                      context,
                      MaterialPageRoute(
                        builder: (context) => NextPage(),
                      ),
                    );
                  }
                },
            child: Text('æäº¤'),
          ),
        ],
      ),
    );
  }
}
```

</td>
</tr>
</table>

---

## ğŸ¨ è¿›é˜¶ï¼šä¼˜æƒ åˆ¸é€‰æ‹©å¼¹çª—

### GetX vs Provider å®ç°å¯¹æ¯”

<table>
<tr>
<th>GetXå†™æ³•</th>
<th>Providerå†™æ³•</th>
</tr>
<tr>
<td>

```dart
// GetX - å¼¹çª—
void showCouponDialog() {
  Get.bottomSheet(
    Container(
      child: Obx(() => ListView.builder(
        itemCount: couponController
            .coupons.length,
        itemBuilder: (context, index) {
          final coupon = couponController
              .coupons[index];
          return ListTile(
            title: Text(coupon.name),
            onTap: () {
              cardFeeController
                  .selectCoupon(coupon);
              Get.back();
            },
          );
        },
      )),
    ),
  );
}
```

</td>
<td>

```dart
// Provider - å¼¹çª—
void _showCouponDialog() {
  showModalBottomSheet(
    context: context,
    builder: (BuildContext context) {
      // âš ï¸ ä½¿ç”¨å·²æœ‰çš„ä¼˜æƒ åˆ¸ViewModel
      final couponVM = getIt<CouponViewModel>();

      return StatefulBuilder(
        builder: (context, setModalState) {
          return Column(
            children: [
              Text('é€‰æ‹©ä¼˜æƒ åˆ¸'),
              Expanded(
                child: ListView.builder(
                  itemCount: couponVM.coupons.length,
                  itemBuilder: (context, index) {
                    final coupon =
                        couponVM.coupons[index];
                    return ListTile(
                      title: Text(
                        coupon.coupon.name
                      ),
                      subtitle: Text(
                        '-\$${coupon.coupon.value}'
                      ),
                      onTap: () {
                        // é€‰æ‹©ä¼˜æƒ åˆ¸
                        _cardFeeViewModel
                            .selectCoupon(coupon);
                        Navigator.pop(context);
                      },
                    );
                  },
                ),
              ),
            ],
          );
        },
      );
    },
  );
}
```

</td>
</tr>
</table>

---

## ğŸ“Š å®Œæ•´æµç¨‹å¯¹æ¯”å›¾

### GetX æµç¨‹

```
User tap button
    â†“
controller.createPayment()  (è‡ªåŠ¨æ›´æ–°UI)
    â†“
Obx è‡ªåŠ¨é‡å»º
```

### Provider æµç¨‹ï¼ˆé¡¹ç›®ï¼‰

```
User tap button
    â†“
_cardFeeViewModel.createPayment()
    â†“
notifyListeners()  â† æ‰‹åŠ¨è°ƒç”¨
    â†“
_onViewModelChanged()  â† ç›‘å¬å›è°ƒ
    â†“
setState(() {})  â† å¼ºåˆ¶é‡å»º
```

---

## ğŸ”§ è°ƒè¯•æŠ€å·§

### GetX è°ƒè¯•

```dart
// ç›´æ¥æ‰“å°
print(controller.isLoading.value);
print(controller.payment.value?.transactionRef);
```

### Provider è°ƒè¯•ï¼ˆé¡¹ç›®ï¼‰

```dart
// åœ¨ViewModelæ–¹æ³•é‡Œæ‰“å°
print('CardFeeViewModel: isLoading=$_isLoading');
print('CardFeeViewModel: payment=${_payment?.transactionRef}');

// æˆ–åœ¨UIé‡Œæ‰“å°
print('UI: isLoading=${_cardFeeViewModel.isLoading}');
```

---

## âš ï¸ å¸¸è§é”™è¯¯å¯¹ç…§è¡¨

| é”™è¯¯            | GetX                           | Provider (é¡¹ç›®)                          |
| --------------- | ------------------------------ | ---------------------------------------- |
| **å¿˜è®°æ›´æ–° UI** | âŒ ä¸ä¼šå‘ç”Ÿï¼ˆè‡ªåŠ¨ï¼‰            | âœ… å¿˜è®°è°ƒç”¨`notifyListeners()`           |
| **å˜é‡è®¿é—®**    | `controller.name.value`        | `viewModel.name` (é€šè¿‡ getter)           |
| **å†…å­˜æ³„æ¼**    | `Get.delete<>()`               | å¿˜è®°`removeListener()`                   |
| **åˆå§‹åŒ–**      | `Get.put()` æˆ– `Get.lazyPut()` | `late ViewModel _vm; _vm = ViewModel();` |

---

## ğŸ¯ å®æˆ˜æ£€æŸ¥æ¸…å•

### æ·»åŠ æ–°åŠŸèƒ½æ—¶çš„æ­¥éª¤

- [ ] **Step 1**: åˆ›å»º Modelï¼ˆGetX å’Œ Provider ä¸€æ ·ï¼‰
- [ ] **Step 2**: åˆ›å»º Service ç»§æ‰¿`BaseService`
- [ ] **Step 3**: åˆ›å»º ViewModel ç»§æ‰¿`ChangeNotifier`
  - [ ] ç§æœ‰å˜é‡ç”¨ `_` å¼€å¤´
  - [ ] æ·»åŠ  getter
  - [ ] æ¯æ¬¡ä¿®æ”¹çŠ¶æ€åè°ƒç”¨ `notifyListeners()`
- [ ] **Step 4**: UI ç”¨`StatefulWidget`
  - [ ] `initState`é‡Œåˆ›å»º ViewModel
  - [ ] `addListener(_onChanged)`
  - [ ] `_onChanged`é‡Œè°ƒç”¨`setState(() {})`
  - [ ] `dispose`é‡Œ`removeListener`

---

## ğŸ’¡ å¿«é€Ÿè®°å¿†å£è¯€

**Provider ä¸‰æ­¥èµ°**ï¼š

1. **ç§æœ‰å˜é‡** + **getter** ï¼ˆä»£æ›¿ GetX çš„.obsï¼‰
2. **notifyListeners()** ï¼ˆä»£æ›¿ GetX çš„è‡ªåŠ¨æ›´æ–°ï¼‰
3. **addListener** + **setState** ï¼ˆä»£æ›¿ GetX çš„ Obxï¼‰

**è®°ä½è¿™ä¸‰ç‚¹ï¼ŒProvider å°±å­¦ä¼šäº†ï¼**

---

## ğŸ“– ä¸‹ä¸€æ­¥å­¦ä¹ 

1. âœ… å…ˆç”¨è¿™ä¸ªæ¨¡æ¿å†™ä¸€ä¸ªç®€å•åŠŸèƒ½
2. âœ… æ¨¡ä»¿é¡¹ç›®ç°æœ‰çš„ ViewModelï¼ˆå¦‚`CouponViewModel`ï¼‰
3. âœ… æ…¢æ…¢é€‚åº”æ‰‹åŠ¨è°ƒç”¨`notifyListeners()`
4. âœ… ç†è§£ä¸ºä»€ä¹ˆè¦`addListener`å’Œ`removeListener`

---

_åŠ æ²¹ï¼å…¶å® Provider æ¯” GetX æ›´çµæ´»ï¼Œåªæ˜¯å¤šå†™å‡ è¡Œä»£ç è€Œå·²ï¼_
